<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/layout :: layout(pageTitle='Gestion des Messages', content=~{::content})}">
<head>
    <title>Gestion des Messages</title>
</head>
<body>
    <div th:fragment="content">
        <!-- En-tête -->
        <div class="content-section">
            <div class="row align-items-center mb-3">
                <div class="col-md-8">
                    <h2 class="mb-0">
                        <i class="fas fa-envelope"></i> Messages de Contact
                    </h2>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-primary fs-5">
                        Total : <span th:text="${contacts != null ? contacts.size() : 0}">0</span> message(s)
                    </span>
                    <span class="badge bg-warning fs-5 ms-2" th:if="${contacts != null}">
                        Non lus : <span th:text="${#lists.size(contacts.?[!read])}">0</span>
                    </span>
                </div>
            </div>

            <!-- Filtres -->
            <div class="btn-group mb-3" role="group">
                <a href="/admin/contacts" class="btn btn-outline-primary"
                   th:classappend="${param.filter == null ? 'active' : ''}">
                    <i class="fas fa-list"></i> Tous
                </a>
                <a href="/admin/contacts?filter=unread" class="btn btn-outline-warning"
                   th:classappend="${param.filter != null and param.filter[0] == 'unread' ? 'active' : ''}">
                    <i class="fas fa-envelope"></i> Non lus
                </a>
                <a href="/admin/contacts?filter=read" class="btn btn-outline-secondary"
                   th:classappend="${param.filter != null and param.filter[0] == 'read' ? 'active' : ''}">
                    <i class="fas fa-envelope-open"></i> Lus
                </a>
            </div>
        </div>

        <!-- Liste des messages -->
        <div class="content-section">
            <div th:if="${contacts == null or #lists.isEmpty(contacts)}" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Aucun message trouvé.
            </div>

            <div th:if="${contacts != null and !#lists.isEmpty(contacts)}">
                <div class="table-responsive custom-table">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Statut</th>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Sujet</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="contact : ${contacts}" 
                                th:classappend="${!contact.read ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <i class="fas fa-envelope" th:if="${!contact.read}" 
                                       style="color: #FFC107;" title="Non lu"></i>
                                    <i class="fas fa-envelope-open" th:if="${contact.read}" 
                                       style="color: #6C757D;" title="Lu"></i>
                                </td>
                                <td>
                                    <strong th:text="${contact.name}">Nom</strong>
                                </td>
                                <td>
                                    <a th:href="'mailto:' + ${contact.email}" th:text="${contact.email}">email@example.com</a>
                                </td>
                                <td th:text="${contact.subject}">Sujet du message</td>
                                <td th:text="${#temporals.format(contact.submittedAt, 'dd/MM/yyyy HH:mm')}">01/01/2025 10:00</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <!-- Bouton Voir/Lire -->
                                        <button type="button" class="btn btn-sm btn-info text-white" 
                                                data-bs-toggle="modal" 
                                                th:attr="data-bs-target='#messageModal' + ${contact.id}"
                                                title="Voir le message">
                                            <i class="fas fa-eye"></i>
                                        </button>

                                        <!-- Bouton Marquer comme lu/non lu -->
                                        <form th:action="@{/admin/contacts/toggle-read/{id}(id=${contact.id})}" 
                                              method="post" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-secondary" 
                                                    th:title="${contact.read ? 'Marquer comme non lu' : 'Marquer comme lu'}">
                                                <i class="fas" th:classappend="${contact.read ? 'fa-envelope' : 'fa-envelope-open'}"></i>
                                            </button>
                                        </form>

                                        <!-- Bouton Supprimer -->
                                        <form th:action="@{/admin/contacts/delete/{id}(id=${contact.id})}" 
                                              method="post" 
                                              onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce message ?');" 
                                              style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modals pour voir les messages -->
        <div th:each="contact : ${contacts}">
            <div class="modal fade" th:id="'messageModal' + ${contact.id}" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-envelope-open-text"></i> Message de <span th:text="${contact.name}">Nom</span>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <strong><i class="fas fa-user"></i> Nom :</strong>
                                <span th:text="${contact.name}">Nom</span>
                            </div>
                            <div class="mb-3">
                                <strong><i class="fas fa-envelope"></i> Email :</strong>
                                <a th:href="'mailto:' + ${contact.email}" th:text="${contact.email}">email@example.com</a>
                            </div>
                            <div class="mb-3">
                                <strong><i class="fas fa-tag"></i> Sujet :</strong>
                                <span th:text="${contact.subject}">Sujet</span>
                            </div>
                            <div class="mb-3">
                                <strong><i class="fas fa-calendar"></i> Date :</strong>
                                <span th:text="${#temporals.format(contact.submittedAt, 'dd MMMM yyyy à HH:mm', new java.util.Locale('fr'))}">Date</span>
                            </div>
                            <hr>
                            <div>
                                <strong><i class="fas fa-comment"></i> Message :</strong>
                                <div class="mt-2 p-3" style="background-color: #f8f9fa; border-left: 4px solid #FF6B35; border-radius: 5px;">
                                    <p th:text="${contact.message}" style="white-space: pre-wrap; margin-bottom: 0;">Message du contact</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a th:href="'mailto:' + ${contact.email} + '?subject=Re: ' + ${contact.subject}" 
                               class="btn btn-primary">
                                <i class="fas fa-reply"></i> Répondre par Email
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="content-section">
            <h3><i class="fas fa-chart-pie"></i> Statistiques des Messages</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">Messages Non Lus</h5>
                            <h2 class="card-text" th:text="${contacts != null ? #lists.size(contacts.?[!read]) : 0}">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-secondary">Messages Lus</h5>
                            <h2 class="card-text" th:text="${contacts != null ? #lists.size(contacts.?[read]) : 0}">0</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
